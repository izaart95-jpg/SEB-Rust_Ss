name: CHAT

on:
  workflow_dispatch:

jobs:
  chat-ngrok-runner:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # ================= SSHX =================
      - name: Download and extract sshx
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $env:DESKTOP_DIR = "$env:USERPROFILE\Desktop"
          cd $env:DESKTOP_DIR
          Invoke-WebRequest `
            -Uri "https://sshx.s3.amazonaws.com/sshx-x86_64-pc-windows-msvc.zip" `
            -OutFile "sshx.zip"
          Expand-Archive -Path "sshx.zip" -DestinationPath "." -Force
          Unblock-File "sshx.exe"
          "SSHX_EXE=$env:DESKTOP_DIR\sshx.exe" | Out-File $env:GITHUB_ENV -Append

      - name: Run sshx and capture session URL
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd $env:DESKTOP_DIR
          $outFile = "$env:DESKTOP_DIR\sshx_output.txt"
          Start-Process `
            -FilePath "cmd.exe" `
            -ArgumentList "/c `"$env:SSHX_EXE > `"$outFile`" 2>&1`"" `
            -NoNewWindow
          Start-Sleep -Seconds 10
          $content = Get-Content $outFile -Raw
          $match = $content | Select-String -Pattern 'https://sshx\.io/s/\S+'
          Write-Host ""
          Write-Host "================ SSHX SESSION ================"
          if ($match) {
            $url = $match.Matches[0].Value
            Write-Host "SSHX LINK: $url"
            "SSHX_URL=$url" | Out-File $env:GITHUB_ENV -Append
          } else {
            Write-Host "SSHX link not detected"
            Write-Host $content
          }
          Write-Host "=============================================="
          Write-Host ""

      - name: Prepare Downloads directory
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $dl = "$env:USERPROFILE\Downloads\chat-work"
          New-Item -ItemType Directory -Force -Path $dl
          echo "WORK_DIR=$dl" >> $env:GITHUB_ENV

          $startTime = [DateTimeOffset]::UtcNow.ToUnixTimeSeconds()
          echo "START_TIME=$startTime" >> $env:GITHUB_ENV

      - name: Download and extract chat.tar
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd $env:WORK_DIR

          curl.exe --fail -L -o chat.tar `
            https://abstrusely-procompensation-phuong.ngrok-free.dev/chat.tar

          tar -xf chat.tar

      - name: Install npm dependencies
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd "$env:WORK_DIR\chat-main"
          npm install

      - name: Download ngrok.exe
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd $env:WORK_DIR

          curl.exe --fail -L -o ngrok.zip `
            https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip

          Expand-Archive ngrok.zip -Force
          $ngrok = Get-ChildItem -Recurse -Filter ngrok.exe | Select-Object -First 1
          echo "NGROK_EXE=$($ngrok.FullName)" >> $env:GITHUB_ENV

      - name: Configure ngrok auth
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          & "$env:NGROK_EXE" config add-authtoken 36kAMHU3fGiD51IZZ91dX7y9QWB_4xSjCmBjUCyD2137xtnKh

      - name: Run Node server and ngrok with timer
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          cd "$env:WORK_DIR\chat-main"

          $targetDuration = (5 * 60 + 50) * 60
          $
