name: Parsec Screenshot Workflow

on:
  workflow_dispatch:

jobs:
  parsec-screenshot:
    runs-on: windows-latest
    timeout-minutes: 280  # 48 hours (2 days)

    steps:
      - name: Download Parsec installer
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecInstaller = "$env:TEMP\parsec-installer.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecInstaller
          echo "PARSEC_INSTALLER=$parsecInstaller" >> $env:GITHUB_ENV

      - name: Download NirCmd for screenshots
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $nircmdZip = "$env:TEMP\nircmd.zip"
          $nircmdDir = "$env:TEMP\nircmd"
          
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdZip
          Expand-Archive -Path $nircmdZip -DestinationPath $nircmdDir -Force
          Copy-Item "$nircmdDir\nircmd.exe" "$env:TEMP\nircmd.exe"
          echo "NIRCMD_PATH=$env:TEMP\nircmd.exe" >> $env:GITHUB_ENV

      - name: Create working directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec-screenshots"
          New-Item -ItemType Directory -Path $workDir -Force
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Set-Location $workDir

      - name: Test NirCmd screenshot
        run: |
          Write-Host "Testing NirCmd..."
          & $env:NIRCMD_PATH savescreenshot full "test_screenshot.png"
          if (Test-Path "test_screenshot.png") {
              Write-Host "✓ Screenshot test successful"
          } else {
              Write-Host "✗ Screenshot test failed"
          }

      - name: Install Parsec (Silent System Install)
        run: |
          Write-Host "Installing Parsec system-wide..."
          Start-Process -FilePath $env:PARSEC_INSTALLER -ArgumentList "/S", "/ALLUSERS" -Wait
          Write-Host "Installation completed. Waiting for Parsec to start..."
          Start-Sleep -Seconds 15

      - name: Wait for Parsec to initialize
        run: |
          Write-Host "Waiting for Parsec to fully initialize..."
          Start-Sleep -Seconds 30
          
          # Take initial screenshot
          & $env:NIRCMD_PATH savescreenshot full "parsec_initial.png"
          Write-Host "Initial screenshot taken"

      - name: Check Parsec processes
        run: |
          Write-Host "Checking for Parsec processes..."
          $processes = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          if ($processes) {
              Write-Host "Found Parsec processes:"
              $processes | Format-Table -AutoSize
          } else {
              Write-Host "No Parsec processes found"
          }

      - name: Take screenshot before login
        run: |
          Write-Host "Taking screenshot of Parsec login screen..."
          & $env:NIRCMD_PATH savescreenshot full "parsec_login_screen.png"
          Write-Host "Login screen screenshot saved"

      - name: Display instructions for manual 2FA
        run: |
          Write-Host "=========================================="
          Write-Host "MANUAL STEP REQUIRED:"
          Write-Host "1. Check email ffbewafa709@gmail.com for 2FA code"
          Write-Host "2. The workflow will wait 60 seconds for you to get the code"
          Write-Host "3. After 60 seconds, it will continue automatically"
          Write-Host "=========================================="
          Start-Sleep -Seconds 60

      - name: Take screenshot after 2FA wait
        run: |
          Write-Host "Taking screenshot after 2FA wait..."
          & $env:NIRCMD_PATH savescreenshot full "parsec_post_2fa_wait.png"
          Write-Host "Post-2FA screenshot saved"
          Start-Sleep -Seconds 10

      - name: Try to interact with Parsec UI
        run: |
          Write-Host "Attempting to interact with Parsec UI..."
          
          # Take multiple screenshots
          for ($i = 1; $i -le 5; $i++) {
              $screenshotPath = "parsec_ui_attempt_$i.png"
              & $env:NIRCMD_PATH savescreenshot full $screenshotPath
              Write-Host "Screenshot $i taken"
              Start-Sleep -Seconds 2
          }

      - name: Verify screenshots exist
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Checking for screenshots..."
          
          $pngFiles = Get-ChildItem -Path . -Filter "*.png" -Force
          Write-Host "Found $($pngFiles.Count) PNG files:"
          $pngFiles | ForEach-Object {
              $sizeKB = $_.Length / 1KB
              Write-Host "  - $($_.Name) ($($sizeKB.ToString('0.00')) KB)"
          }
          
          if ($pngFiles.Count -eq 0) {
              Write-Host "WARNING: No PNG files found!"
              Write-Host "Listing all files:"
              Get-ChildItem -Path . -Force
          }

      - name: Upload all screenshots as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: D:\a\SEB\SEB\parsec-screenshots\*.png
          retention-days: 2

      - name: Keep workflow running extended period
        run: |
          Write-Host "=========================================="
          Write-Host "PARSCREENSHOT WORKFLOW ACTIVE"
          Write-Host "Parsec should be installed and running"
          Write-Host "Screenshots have been captured"
          Write-Host "Workflow will run for extended period"
          Write-Host "=========================================="
          
          # Take periodic screenshots
          $startTime = Get-Date
          $counter = 1
          
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 2) {
              $hoursRunning = (New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours
              Write-Host "[$(Get-Date)] Running for $([math]::Round($hoursRunning, 2)) hours"
              
              # Take screenshot every 10 minutes
              if ($counter % 20 -eq 0) {
                  $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
                  & $env:NIRCMD_PATH savescreenshot full "periodic_${timestamp}.png"
                  Write-Host "Periodic screenshot taken"
              }
              
              $counter++
              Start-Sleep -Seconds 30
          }
          
          Write-Host "Time limit reached, workflow completed"
