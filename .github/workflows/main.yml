name: Parsec Screenshot Final
on:
  workflow_dispatch:

jobs:
  parsec-screenshots:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup with absolute path
        run: |
          # Use absolute path consistently
          $workDir = "D:\a\SEB\SEB\screenshots"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          echo "Current dir: $(Get-Location)"

      - name: Get NirCmd
        run: |
          # Simple method - use direct download
          $nircmdUrl = "https://raw.githubusercontent.com/actions/virtual-environments/main/images/win/scripts/Helpers/nircmd.exe"
          $nircmdPath = "$env:WORK_DIR\nircmd.exe"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdPath
          echo "NIRCMD_PATH=$nircmdPath" >> $env:GITHUB_ENV

      - name: Take initial screenshot
        run: |
          Write-Host "Taking initial screenshot..."
          & $env:NIRCMD_PATH savescreenshotfull "initial.png"
          Write-Host "Files in $env:WORK_DIR:"
          Get-ChildItem

      - name: Download Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          Write-Host "Parsec downloaded"

      - name: Install Parsec
        run: |
          Write-Host "Installing Parsec..."
          Start-Process -FilePath "$env:WORK_DIR\parsec.exe" -ArgumentList "/S" -Wait
          Start-Sleep -Seconds 10
          
          # Take screenshot after install
          & $env:NIRCMD_PATH savescreenshotfull "after_install.png"

      - name: Take multiple Parsec screenshots
        run: |
          Write-Host "Taking Parsec screenshots..."
          
          # Take 5 screenshots with delays
          for ($i = 1; $i -le 5; $i++) {
              $fileName = "parsec_$i.png"
              & $env:NIRCMD_PATH savescreenshotfull $fileName
              Write-Host "Screenshot $i: $fileName"
              Start-Sleep -Seconds 2
          }

      - name: Verify files exist
        run: |
          Write-Host "=== VERIFYING FILES ==="
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Absolute path: $((Get-Location).Path)"
          
          Write-Host "All files in work directory:"
          Get-ChildItem -Path $env:WORK_DIR | Format-Table -AutoSize
          
          Write-Host "PNG files specifically:"
          $pngFiles = Get-ChildItem -Path $env:WORK_DIR -Filter "*.png"
          Write-Host "Found $($pngFiles.Count) PNG files"
          $pngFiles | ForEach-Object {
              $sizeKB = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  - $($_.Name) ($sizeKB KB)"
          }
          
          # Also check parent directory
          Write-Host "Checking parent directory:"
          Get-ChildItem -Path "D:\a\SEB\SEB" -Filter "*.png" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found in parent: $($_.Name)"
          }

      - name: Upload screenshots artifact
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: D:\a\SEB\SEB\screenshots\*.png
          retention-days: 1

      - name: Upload all files artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-files
          path: D:\a\SEB\SEB\screenshots
          retention-days: 1

      - name: Final verification
        run: |
          Write-Host "=== WORKFLOW COMPLETE ==="
          Write-Host "Check these artifacts:"
          Write-Host "1. 'parsec-screenshots' - should contain PNG files"
          Write-Host "2. 'all-files' - contains everything in screenshots folder"
          Write-Host ""
          Write-Host "If no screenshots appear, the issue is:"
          Write-Host "1. Screenshots are black/empty in CI environment"
          Write-Host "2. NirCmd isn't capturing the screen"
          Write-Host "3. Some other permission issue"
