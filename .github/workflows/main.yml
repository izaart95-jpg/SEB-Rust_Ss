name: RustDesk Screenshot Capture

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 30  # Total timeout includes 20 minutes of runtime

    steps:
      - name: Install RustDesk
        run: |
          echo "=== Installing RustDesk ==="
          
          # Download RustDesk
          curl -L -o rustdesk.dmg "https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk.dmg" || \
          curl -L -o rustdesk.dmg "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg"
          
          # Mount and install
          hdiutil attach rustdesk.dmg -mountpoint /Volumes/RustDesk -nobrowse
          sudo cp -R "/Volumes/RustDesk/RustDesk.app" /Applications/
          hdiutil detach /Volumes/RustDesk
          rm -f rustdesk.dmg
          
          echo "✅ RustDesk installed"

      - name: Start RustDesk
        run: |
          echo "=== Starting RustDesk ==="
          
          # Launch RustDesk
          open -a /Applications/RustDesk.app
          
          # Wait for it to start
          sleep 10
          
          # Check if running
          if pgrep -f "RustDesk" > /dev/null; then
            echo "✅ RustDesk is running"
            
            # Get RustDesk ID from window title or logs
            echo "RustDesk ID should be visible in the application window"
          else
            echo "⚠️ RustDesk may not have started properly"
          fi

      - name: Get display resolution
        run: |
          echo "=== Getting display resolution ==="
          
          # Get primary display resolution
          RESOLUTION=$(system_profiler SPDisplaysDataType | grep "Resolution" | head -1 | awk '{print $2 "x" $4}')
          
          if [ -z "$RESOLUTION" ]; then
            # Alternative method
            RESOLUTION=$(system_profiler SPDisplaysDataType | grep -A1 "Resolution:" | tail -1 | xargs)
          fi
          
          if [ -z "$RESOLUTION" ]; then
            # Fallback to system command
            RESOLUTION=$(/usr/sbin/system_profiler SPDisplaysDataType | awk '/Resolution:/ {print $2 "x" $4; exit}')
          fi
          
          echo "Detected resolution: ${RESOLUTION:-Unknown}"
          echo "RESOLUTION=${RESOLUTION:-Unknown}" >> $GITHUB_ENV
          
          # Create screenshots directory
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Take 5 screenshots
        run: |
          echo "=== Taking 5 screenshots ==="
          echo "Display resolution: $RESOLUTION"
          
          # Take 5 screenshots with 2-second intervals
          for i in {1..5}; do
            echo "Taking screenshot $i..."
            
            timestamp=$(date +%Y%m%d_%H%M%S)
            screenshot_file="$SCREENSHOT_DIR/screenshot_${i}_${timestamp}.png"
            
            # Take screenshot with timestamp in filename
            screencapture -x "$screenshot_file"
            
            # Verify screenshot was created
            if [ -f "$screenshot_file" ]; then
              size=$(ls -lh "$screenshot_file" | awk '{print $5}')
              dimensions=$(file "$screenshot_file" | grep -o "[0-9]* x [0-9]*" | head -1)
              echo "  Screenshot $i: ${size} (${dimensions})"
            else
              echo "  ⚠️ Screenshot $i not created"
            fi
            
            # Wait 2 seconds between screenshots (except after last one)
            if [ $i -lt 5 ]; then
              sleep 2
            fi
          done
          
          # List all screenshots
          echo ""
          echo "All screenshots:"
          ls -la "$SCREENSHOT_DIR/"

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep system running for 20 minutes
        run: |
          echo "=== Keeping system active for 20 minutes ==="
          echo "Start time: $(date)"
          echo "Will run until: $(date -v+20M)"
          echo ""
          echo "RustDesk should remain running during this time"
          echo "You can remotely access via RustDesk ID"
          echo ""
          
          # Display RustDesk status
          echo "RustDesk Status:"
          if pgrep -f "RustDesk" > /dev/null; then
            echo "✅ RustDesk is running"
          else
            echo "❌ RustDesk is not running"
            echo "Attempting to restart RustDesk..."
            open -a /Applications/RustDesk.app
            sleep 5
          fi
          
          # Run for exactly 20 minutes
          echo ""
          echo "Countdown:"
          for minute in {20..1}; do
            echo "$minute minutes remaining..."
            sleep 60
          done
          
          echo "✅ 20 minutes completed"

      - name: Cleanup
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          # Stop RustDesk
          pkill -f "RustDesk" 2>/dev/null || true
          
          echo "✅ RustDesk stopped"
          echo "Workflow completed"
