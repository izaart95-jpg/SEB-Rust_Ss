name: Parsec Screenshot Debug

on:
  workflow_dispatch:

jobs:
  parsec-debug:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Setup and debug
        run: |
          Write-Host "=== SYSTEM INFO ==="
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Write-Host "Runner temp: $env:RUNNER_TEMP"
          Write-Host "Current dir: $(Get-Location)"
          
          # Create working directory in runner workspace
          $workDir = "$env:GITHUB_WORKSPACE\parsec-debug"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          Write-Host "Work directory: $workDir"
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV

      - name: Download NirCmd
        run: |
          # Simple NirCmd download
          $nircmdUrl = "https://github.com/actions/virtual-environments/raw/main/images/win/scripts/Helpers/nircmd.exe"
          $nircmdPath = "$env:WORK_DIR\nircmd.exe"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $nircmdPath
          
          # Test it
          & $nircmdPath cmdhelp > "$env:WORK_DIR\nircmd_test.txt" 2>&1
          echo "NIRCMD_PATH=$nircmdPath" >> $env:GITHUB_ENV
          
          Write-Host "NirCmd downloaded to: $nircmdPath"
          Write-Host "Test output saved"

      - name: Take test screenshot
        run: |
          Write-Host "=== Taking test screenshot ==="
          Write-Host "Current dir: $(Get-Location)"
          Write-Host "NirCmd path: $env:NIRCMD_PATH"
          
          # Method 1: NirCmd
          $testFile1 = "test_nircmd.png"
          & $env:NIRCMD_PATH savescreenshot full "$testFile1"
          
          # Method 2: PowerShell .NET
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          
          $testFile2 = "test_powershell.png"
          $bitmap.Save($testFile2, [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          Write-Host "Screenshots taken:"
          Get-ChildItem -Filter "*.png" | Format-Table -AutoSize

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec..."
          # Try different installation methods
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10
          
          Write-Host "Checking installation..."
          Get-Process | Where-Object { $_.ProcessName -like "*parsec*" } | Format-Table -AutoSize

      - name: Take Parsec screenshots
        run: |
          Write-Host "Taking Parsec screenshots..."
          Set-Location $env:WORK_DIR
          
          # Take multiple screenshots
          for ($i = 1; $i -le 3; $i++) {
              $fileName = "parsec_$i.png"
              & $env:NIRCMD_PATH savescreenshot full $fileName
              Write-Host "Taken: $fileName"
              Start-Sleep -Seconds 2
          }
          
          # Also try PowerShell method
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("parsec_powershell.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: List all files
        run: |
          Write-Host "=== ALL FILES IN WORK DIR ==="
          Set-Location $env:WORK_DIR
          Get-ChildItem -Path . -Recurse -Force | Format-Table -Property Name, Length, LastWriteTime -AutoSize
          
          Write-Host "=== PNG FILES ONLY ==="
          $pngFiles = Get-ChildItem -Path . -Filter "*.png" -Recurse -Force
          Write-Host "Found $($pngFiles.Count) PNG files"
          $pngFiles | ForEach-Object {
              $sizeKB = [math]::Round($_.Length / 1KB, 2)
              Write-Host "  - $($_.Name) ($sizeKB KB) at: $($_.FullName)"
          }
          
          # Also check common locations
          Write-Host "=== CHECKING COMMON PATHS ==="
          $paths = @("$env:GITHUB_WORKSPACE", "$env:RUNNER_TEMP", "C:\")
          foreach ($path in $paths) {
              if (Test-Path $path) {
                  $found = Get-ChildItem -Path $path -Filter "*.png" -ErrorAction SilentlyContinue | Select-Object -First 2
                  if ($found) {
                      Write-Host "PNGs in $path : $($found.Count)"
                  }
              }
          }

      - name: Upload everything as artifact
        uses: actions/upload-artifact@v4
        with:
          name: parsec-all-files
          path: ${{ env.WORK_DIR }}
          retention-days: 7

      - name: Upload just screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots-only
          path: ${{ env.WORK_DIR }}/*.png
          if-no-files-found: warn
          retention-days: 7

      - name: Final debug info
        run: |
          Write-Host "=== FINAL DEBUG INFO ==="
          Write-Host "Artifact paths to check:"
          Write-Host "1. parsec-all-files (contains all files)"
          Write-Host "2. parsec-screenshots-only (just PNGs)"
          Write-Host ""
          Write-Host "If no screenshots appear in artifacts, check:"
          Write-Host "1. NirCmd is working: $env:NIRCMD_PATH"
          Write-Host "2. Files were created in: $env:WORK_DIR"
          Write-Host "3. GitHub Actions has permission to access files"
