name: RustDesk Screenshot

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshot:
    runs-on: windows-latest
    timeout-minutes: 400  # 6 hours + buffer
    
    steps:
      - name: Download PS1 script
        run: |
          # Change this URL to where your PS1 is hosted
          $scriptUrl = "https://archive.org/download/information_20251119/screenshot-tool.ps1"
          $scriptPath = "$env:GITHUB_WORKSPACE\screenshot-tool.ps1"
          
          Write-Host "Downloading PS1 script..."
          Invoke-WebRequest -Uri $scriptUrl -OutFile $scriptPath
          
          if (Test-Path $scriptPath) {
              Write-Host "Script downloaded: $((Get-Item $scriptPath).Length) bytes"
          } else {
              Write-Error "Failed to download script"
              exit 1
          }
      
      - name: Unblock and run PS1
        run: |
          $scriptPath = "$env:GITHUB_WORKSPACE\screenshot-tool.ps1"
          
          # Unblock the file
          Unblock-File -Path $scriptPath
          
          # Run with bypass
          Write-Host "Executing script..."
          powershell -ExecutionPolicy Bypass -File $scriptPath
          
      - name: Upload initial screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-initial-screenshots
          path: ${{ github.workspace }}/screenshots/screenshot_*.png
          if-no-files-found: warn
          retention-days: 1
          
      - name: Upload periodic screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-periodic-screenshots
          path: ${{ github.workspace }}/screenshots/periodic_*.png
          if-no-files-found: warn
          retention-days: 1
          
      - name: Final file list
        if: always()
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\screenshots"
          if (Test-Path $workDir) {
              Write-Host "=== Files in screenshot directory ==="
              $files = Get-ChildItem -Path $workDir -File
              Write-Host "Total files: $($files.Count)"
              $files | ForEach-Object {
                  Write-Host "$($_.Name) - $([math]::Round($_.Length/1KB,2)) KB"
              }
          } else {
              Write-Host "Screenshot directory not found"
          }
