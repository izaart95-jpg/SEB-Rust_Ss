name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download screenshot tools
        run: |
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $zipPath = "$env:TEMP\nircmd.zip"
          Write-Host "Downloading NirCmd..."
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
          $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($nircmdExe) {
              Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
          }

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec and take initial screenshot
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 8
          
          # Take initial screenshot
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\initial_screen.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Clear ALL fields first approach
        run: |
          Write-Host "=== CLEAR ALL FIELDS FIRST ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # Step 1: Click to focus the window
          Write-Host "Focusing Parsec window..."
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              $width = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Width
              $height = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Height
              $centerX = [math]::Round($width / 2)
              $centerY = [math]::Round($height / 2)
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $centerX $centerY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
          }
          
          Start-Sleep -Seconds 2
          
          # Step 2: Clear EVERYTHING from all fields using multiple Tabs
          Write-Host "Clearing all possible fields..."
          
          # Try to clear email field (usually first field)
          [System.Windows.Forms.SendKeys]::SendWait("^a")  # Ctrl+A
          [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")
          Start-Sleep -Milliseconds 500
          
          # Tab to next field and clear it
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("^a")
          [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")
          Start-Sleep -Milliseconds 500
          
          # Tab to next field and clear it (in case there are 3 fields)
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("^a")
          [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")
          Start-Sleep -Milliseconds 500
          
          # Tab back to first field (Shift+Tab)
          [System.Windows.Forms.SendKeys]::SendWait("+{TAB}")  # Shift+Tab
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("+{TAB}")  # Shift+Tab again
          Start-Sleep -Seconds 1
          
          # Take screenshot after clearing
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_clearing.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Enter email in FIRST field only
        run: |
          Write-Host "=== ENTERING EMAIL IN FIRST FIELD ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # We should be in email field after clearing
          Write-Host "Typing email in first field..."
          
          # Type email character by character
          $email = "ffbewafa709@gmail.com"
          foreach ($char in $email.ToCharArray()) {
              [System.Windows.Forms.SendKeys]::SendWait("$char")
              Start-Sleep -Milliseconds 50
          }
          
          Write-Host "Email typed: $email"
          Start-Sleep -Seconds 1
          
          # Take screenshot after email
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\email_entered.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Navigate to password field carefully
        run: |
          Write-Host "=== NAVIGATING TO PASSWORD FIELD ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # METHOD A: Try Tab key first
          Write-Host "Trying Tab to navigate to password field..."
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Seconds 1
          
          # Take screenshot to see if we're in password field
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_tab.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          # METHOD B: If Tab didn't work, use mouse click
          Write-Host "Trying mouse click for password field..."
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              $width = $bounds.Width
              $height = $bounds.Height
              
              # Click slightly below where we clicked for email
              $passwordX = [math]::Round($width / 2)
              $passwordY = [math]::Round($height / 2) + 40  # 40 pixels below center
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $passwordX $passwordY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick  # Double click to select
              Write-Host "Clicked at: $passwordX, $passwordY"
          }
          
          Start-Sleep -Seconds 1

      - name: Enter password in SECOND field
        run: |
          Write-Host "=== ENTERING PASSWORD ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # Clear any existing text in password field
          Write-Host "Clearing password field..."
          [System.Windows.Forms.SendKeys]::SendWait("^a")  # Ctrl+A
          [System.Windows.Forms.SendKeys]::SendWait("{DELETE}")
          Start-Sleep -Milliseconds 500
          
          # Take screenshot before typing password
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\before_password.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()
          
          # Type password
          Write-Host "Typing password..."
          $password = "Hamza@123456"
          foreach ($char in $password.ToCharArray()) {
              [System.Windows.Forms.SendKeys]::SendWait("$char")
              Start-Sleep -Milliseconds 50
          }
          
          Write-Host "Password typed: $password"
          Start-Sleep -Seconds 1
          
          # Take screenshot after password
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\password_entered.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Submit login
        run: |
          Write-Host "=== SUBMITTING LOGIN ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          
          # METHOD 1: Press Enter (might work if password field is focused)
          Write-Host "Trying Enter key..."
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 2
          
          # METHOD 2: Try Tab then Enter
          Write-Host "Trying Tab then Enter..."
          [System.Windows.Forms.SendKeys]::SendWait("{TAB}")
          Start-Sleep -Milliseconds 500
          [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
          Start-Sleep -Seconds 2
          
          # METHOD 3: Mouse click on login button
          Write-Host "Trying mouse click on login button..."
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              $width = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Width
              $height = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds.Height
              
              # Login button is usually below password field
              $loginX = [math]::Round($width / 2)
              $loginY = [math]::Round($height / 2) + 80  # 80 pixels below center
              
              & "$env:WORK_DIR\nircmd.exe" setcursor $loginX $loginY
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              Write-Host "Clicked login at: $loginX, $loginY"
          }
          
          Start-Sleep -Seconds 3
          
          # Take screenshot after submission
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bounds = $screen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
          $bitmap.Save("$env:WORK_DIR\after_submission.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: Verify and document results
        run: |
          Write-Host "=== FINAL VERIFICATION ==="
          Start-Sleep -Seconds 5
          
          # Take final screenshots
          for ($i = 1; $i -le 3; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec process
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "Parsec processes found:"
          $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
          
          # List all screenshots
          Write-Host "=== ALL FILES ==="
          Get-ChildItem -Path $env:WORK_DIR | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: parsec-screenshots
          path: D:\a\SEB\SEB\parsec\*.png
          if-no-files-found: error
          retention-days: 1

      - name: Upload all files as backup
        uses: actions/upload-artifact@v4
        with:
          name: parsec-all-files
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
