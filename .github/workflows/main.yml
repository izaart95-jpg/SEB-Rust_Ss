name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Install RustDesk via Homebrew
        run: |
          echo "=== Installing RustDesk via Homebrew ==="
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          brew install --cask rustdesk
          echo "RustDesk installed"

      - name: Resolution Detect
        run: |
          echo "=== Getting display resolution ==="
          RESOLUTION=$(system_profiler SPDisplaysDataType | grep Resolution | head -1 | sed 's/[^0-9x]//g')

          if [ -z "$RESOLUTION" ]; then
            RESOLUTION="1024x768"
          fi

          WIDTH=$(echo $RESOLUTION | cut -d'x' -f1)
          HEIGHT=$(echo $RESOLUTION | cut -d'x' -f2)

          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV

          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Start RustDesk
        run: |
          echo "Starting RustDesk"
          open -a /Applications/RustDesk.app
          sleep 15

      - name: Initial Screenshot
        run: |
          file="$SCREENSHOT_DIR/before_permission.png"
          screencapture -x "$file"
          echo "Saved: $file"

      - name: Calculate Button Position
        run: |
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIGINAL_X=462
          ORIGINAL_Y=374

          X_SCALE=$(echo "$SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc -l)
          Y_SCALE=$(echo "$SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc -l)

          NEW_X=$(printf "%.0f" $(echo "$ORIGINAL_X * $X_SCALE" | bc -l))
          NEW_Y=$(printf "%.0f" $(echo "$ORIGINAL_Y * $Y_SCALE" | bc -l))

          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV
          echo "Scaled click position: $NEW_X,$NEW_Y"

      - name: Click Allow Button
        run: |
          brew install cliclick
          screencapture -x "$SCREENSHOT_DIR/debug_before_click.png"
          cliclick c:$BUTTON_X,$BUTTON_Y
          sleep 2
          screencapture -x "$SCREENSHOT_DIR/debug_after_click.png"

      - name: Verification Screenshots (5)
        run: |
          for i in {1..5}; do
            file="$SCREENSHOT_DIR/verification_$i.png"
            screencapture -x "$file"
            echo "Saved: $file"
            sleep 2
          done

      - name:  NEW Click 210,563 After Verification
        run: |
          echo "Click at fixed coordinates 210,563"
          brew install cliclick
          cliclick c:210,563
          sleep 2
          file="$SCREENSHOT_DIR/click_fixed_after.png"
          screencapture -x "$file"
          echo "Saved: $file"

      - name: Upload Screenshots Now
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep System Running 20 Minutes (No EOF Bugs)
        run: |
          STATUS="$SCREENSHOT_DIR/rustdesk_status.txt"
          echo "RustDesk 20-Minute Monitor Log" > "$STATUS"

          for i in {1..20}; do
            echo "Minute $i" >> "$STATUS"

            if pgrep -f RustDesk >/dev/null; then
              echo "Running" >> "$STATUS"
            else
              echo "Not running" >> "$STATUS"
              if [ $((i % 5)) -eq 0 ]; then
                open -a /Applications/RustDesk.app || true
              fi
            fi

            if [ $((i % 4)) -eq 0 ]; then
              screencapture -x "$SCREENSHOT_DIR/runtime_$i.png"
            fi

            sleep 60
          done

      - name: Upload Final Status
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rustdesk-final-status
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

